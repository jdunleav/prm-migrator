version: 0.2

phases:
  install:
    commands:
      - apt-get update
      - apt-get install -y jq zip unzip # nodejs npm
  pre_build:
    commands:
      - chmod a+x ./utils/*
  build:
    commands:
      # Installing npm packages 
      - # curl -sL https://deb.nodesource.com/setup_8.x | bash -
      - # sudo apt-get install nodejs build-essential
      - cd $TMPDIR; git clone https://github.com/creationix/nvm.git; cd nvm
      - chmod +x install.sh; ./install.sh; export NVM_DIR="$HOME/.nvm"; \. "$NVM_DIR/nvm.sh" 
      - # \. "$NVM_DIR/nvm.sh"
      - # chmod +x $NVM_DIR/*.sh; . $NVM_DIR/nvm.sh
      - find / | grep nvm.sh
      - nvm --version
      - npm -v
      - node -v
      - cd $CODEBUILD_SRC_DIR/dynamo; npm install
      - cd $CODEBUILD_SRC_DIR/lambda/ehr_extract_handler; npm install
      - cd $CODEBUILD_SRC_DIR/lambda/retrieve_processed_ehr_extract; npm install
      - cd $CODEBUILD_SRC_DIR/lambda/retrieve_status; npm install
      - cd $CODEBUILD_SRC_DIR/uptime_monitoring; npm install
      # Running Owasp dependency-check
      - cd $TMPDIR; wget -nv https://dl.bintray.com/jeremy-long/owasp/dependency-check-4.0.2-release.zip; unzip -q dependency-check-4.0.2-release.zip
      - ./dependency-check/bin/dependency-check.sh  --project secscaprj --enableRetired --scan $CODEBUILD_SRC_DIR
